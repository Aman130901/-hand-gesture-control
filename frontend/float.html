<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Camera Feed</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body,
        html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background: transparent;
            font-family: 'Segoe UI', system-ui, sans-serif;
            user-select: none;
        }

        /* Logic for Draggable Window */
        .window-drag-region {
            -webkit-app-region: drag;
            position: absolute;
            inset: 0;
            z-index: 10;
        }

        .no-drag {
            -webkit-app-region: no-drag;
            z-index: 50;
            /* Above drag region */
        }

        /* Container Design */
        .glass-container {
            width: 100vw;
            height: 100vh;
            border-radius: 16px;
            overflow: hidden;
            position: relative;
            background: #000;
            box-shadow: 0 0 0 1px rgba(255, 255, 255, 0.1), 0 8px 32px rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: box-shadow 0.3s ease;
        }

        .glass-container.active {
            box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.5), 0 0 20px rgba(99, 102, 241, 0.3);
        }

        /* Video Feed */
        img.feed {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: scaleX(-1);
            /* Mirror effect if needed locally, but usually server flips it. Removing flip here if server flips. */
            /* Server flips it, so consistent. */
            transform: none;
            pointer-events: none;
        }

        /* Overlays */
        .gradient-overlay {
            position: absolute;
            inset: 0;
            background: linear-gradient(to bottom, rgba(0, 0, 0, 0.4) 0%, transparent 20%, transparent 70%, rgba(0, 0, 0, 0.8) 100%);
            pointer-events: none;
        }

        .status-pill {
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .close-btn {
            background: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(4px);
            transition: all 0.2s;
        }

        .close-btn:hover {
            background: rgba(239, 68, 68, 0.8);
            transform: scale(1.1);
        }

        .animate-pop {
            animation: pop 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        @keyframes pop {
            0% {
                transform: scale(0.9);
                opacity: 0;
            }

            100% {
                transform: scale(1);
                opacity: 1;
            }
        }
    </style>
</head>

<body class="p-1"> <!-- Padding for Window Resize/Grip if needed, usually 0 is fine if draggable body -->

    <div class="glass-container group" id="mainContainer">
        <!-- DRAG HANDLE (Full Overlay) -->
        <div class="window-drag-region"></div>

        <!-- VIDEO -->
        <img src="/video_feed" class="feed" alt="Camera">
        <div class="gradient-overlay"></div>

        <!-- HEADER (Controls) -->
        <div
            class="absolute top-0 left-0 w-full p-3 flex justify-between items-start z-[60] opacity-0 group-hover:opacity-100 transition-opacity duration-300">
            <!-- Left: Status Dot -->
            <div
                class="status-pill px-2 py-1 rounded-full flex items-center gap-1.5 no-drag select-none cursor-default shadow-lg">
                <div id="statusDot" class="w-1.5 h-1.5 rounded-full bg-red-400 animate-pulse"></div>
                <span class="text-[10px] font-bold text-gray-200 tracking-wider font-mono uppercase">LIVE</span>
            </div>

            <!-- Right: Close -->
            <button onclick="closeWindow()"
                class="no-drag close-btn w-6 h-6 rounded-full flex items-center justify-center text-white shadow-lg cursor-pointer">
                <i data-lucide="x" class="w-3.5 h-3.5"></i>
            </button>
        </div>

        <!-- FOOTER (Action Feedback) -->
        <div class="absolute bottom-4 left-0 w-full flex flex-col items-center pointer-events-none z-[60]">
            <!-- Action Toast -->
            <div id="actionToast"
                class="hidden flex items-center gap-2 status-pill px-3 py-1.5 rounded-full mb-1 border-emerald-500/30 shadow-[0_0_15px_rgba(16,185,129,0.2)] animate-pop">
                <i data-lucide="zap" class="w-3 h-3 text-emerald-400"></i>
                <span id="actionText" class="text-xs font-bold text-emerald-100 tracking-wide uppercase">Action</span>
            </div>

            <!-- Gesture Text -->
            <div
                class="bg-black/20 backdrop-filter blur-[2px] px-2 py-0.5 rounded text-[10px] font-medium text-white/50 tracking-wider uppercase font-mono mt-1">
                <span id="gestureText">Detecting...</span>
            </div>
        </div>
    </div>

    <script>
        lucide.createIcons();

        const container = document.getElementById('mainContainer');
        const actionToast = document.getElementById('actionToast');
        const actionText = document.getElementById('actionText');
        const gestureText = document.getElementById('gestureText');
        const statusDot = document.getElementById('statusDot');

        let lastAction = "";
        let actionTimeout;

        function closeWindow() {
            if (window.pywebview && window.pywebview.api) {
                window.pywebview.api.toggle_floating_window();
            } else {
                console.warn("API not connected");
            }
        }

        async function updateStatus() {
            try {
                const res = await fetch('/api/status');
                const data = await res.json();

                // 1. Gesture
                const gesture = data.detected_gesture;
                gestureText.textContent = (!gesture || gesture === "None") ? "Waiting..." : gesture;
                statusDot.className = `w-1.5 h-1.5 rounded-full ${(!gesture || gesture === "None") ? 'bg-red-400' : 'bg-emerald-400 shadow-[0_0_8px_rgba(52,211,153,0.8)]'} transition-colors duration-300`;

                // 2. Container Active State (Glow)
                if (gesture && gesture !== "None") {
                    container.classList.add('active');
                } else {
                    container.classList.remove('active');
                }

                // 3. Action Trigger
                const action = data.last_action;
                // Only show if it's a new valid action or persistent state like "Tracking"
                // But for toast, we usually just show momentary triggers or meaningful states.
                // If "Tracking", maybe show it differently? 

                if (action && action !== "" && action !== "None") {
                    // Update Text
                    actionText.textContent = action.replace(/_/g, ' ');

                    // Show Toast
                    actionToast.classList.remove('hidden');

                    // Reset hide timer
                    clearTimeout(actionTimeout);
                    actionTimeout = setTimeout(() => {
                        actionToast.classList.add('hidden');
                    }, 2000);
                } else {
                    // If no action for a while, let the timeout hide it.
                }

            } catch (e) {
                // Silent fail
            }
        }

        setInterval(updateStatus, 100);
    </script>
</body>

</html>